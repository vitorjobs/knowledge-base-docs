import{_ as s,o as r,c as i,ah as e,j as o,a as t}from"./chunks/framework.D70b1pOo.js";const b=JSON.parse('{"title":"main.tf - Instância EC2 com acesso via SSM (Sem SSH)","description":"","frontmatter":{},"headers":[],"relativePath":"terraform/EC2/Instância EC2 com acesso via SSM (Sem SSH).md","filePath":"terraform/EC2/Instância EC2 com acesso via SSM (Sem SSH).md"}'),n={name:"terraform/EC2/Instância EC2 com acesso via SSM (Sem SSH).md"};function c(l,a,h,d,u,m){return r(),i("div",null,[...a[0]||(a[0]=[e('<h1 id="main-tf-instancia-ec2-com-acesso-via-ssm-sem-ssh" tabindex="-1">main.tf - Instância EC2 com acesso via SSM (Sem SSH) <a class="header-anchor" href="#main-tf-instancia-ec2-com-acesso-via-ssm-sem-ssh" aria-label="Permalink to “main.tf - Instância EC2 com acesso via SSM (Sem SSH)”">​</a></h1><h1 id="" tabindex="-1">----------------------------- <a class="header-anchor" href="#" aria-label="Permalink to “-----------------------------”">​</a></h1><h1 id="instrucoes-de-uso" tabindex="-1">Instruções de Uso <a class="header-anchor" href="#instrucoes-de-uso" aria-label="Permalink to “Instruções de Uso”">​</a></h1><h1 id="-1" tabindex="-1">----------------------------- <a class="header-anchor" href="#-1" aria-label="Permalink to “-----------------------------”">​</a></h1><h1 id="para-conectar-a-instancia-via-ssm" tabindex="-1">Para conectar à instância via SSM: <a class="header-anchor" href="#para-conectar-a-instancia-via-ssm" aria-label="Permalink to “Para conectar à instância via SSM:”">​</a></h1><h1 id="_1-configure-o-aws-cli-com-o-mesmo-profile-do-terraform" tabindex="-1">1. Configure o AWS CLI com o mesmo profile do Terraform: <a class="header-anchor" href="#_1-configure-o-aws-cli-com-o-mesmo-profile-do-terraform" aria-label="Permalink to “1. Configure o AWS CLI com o mesmo profile do Terraform:”">​</a></h1><h1 id="aws-configure-profile-bia-tf" tabindex="-1">aws configure --profile bia-tf <a class="header-anchor" href="#aws-configure-profile-bia-tf" aria-label="Permalink to “aws configure --profile bia-tf”">​</a></h1><h1 id="-2" tabindex="-1"><a class="header-anchor" href="#-2" aria-label="Permalink to “”">​</a></h1><h1 id="_2-conecte-usando-o-comando" tabindex="-1">2. Conecte usando o comando: <a class="header-anchor" href="#_2-conecte-usando-o-comando" aria-label="Permalink to “2. Conecte usando o comando:”">​</a></h1>',9),o("h1",{"aws_instance.bia_dev_ssm.id":"",id:"aws-ssm-start-session-target",tabindex:"-1"},[t("aws ssm start-session --target $ "),o("a",{class:"header-anchor",href:"#aws-ssm-start-session-target","aria-label":"Permalink to “aws ssm start-session --target $”"},"​")],-1),e('<h1 id="-3" tabindex="-1"><a class="header-anchor" href="#-3" aria-label="Permalink to “”">​</a></h1><h1 id="_3-alternativamente-use-o-console-aws" tabindex="-1">3. Alternativamente, use o Console AWS: <a class="header-anchor" href="#_3-alternativamente-use-o-console-aws" aria-label="Permalink to “3. Alternativamente, use o Console AWS:”">​</a></h1><h1 id="aws-console-systems-manager-session-manager-start-session" tabindex="-1">AWS Console &gt; Systems Manager &gt; Session Manager &gt; Start Session <a class="header-anchor" href="#aws-console-systems-manager-session-manager-start-session" aria-label="Permalink to “AWS Console &gt; Systems Manager &gt; Session Manager &gt; Start Session”">​</a></h1><h1 id="-4" tabindex="-1"><a class="header-anchor" href="#-4" aria-label="Permalink to “”">​</a></h1><h1 id="_4-para-ver-os-logs-das-sessoes" tabindex="-1">4. Para ver os logs das sessões: <a class="header-anchor" href="#_4-para-ver-os-logs-das-sessoes" aria-label="Permalink to “4. Para ver os logs das sessões:”">​</a></h1><h1 id="aws-console-cloudwatch-log-groups-aws-ssm-sessions-bia-instance" tabindex="-1">AWS Console &gt; CloudWatch &gt; Log groups &gt; /aws/ssm/sessions/bia-instance <a class="header-anchor" href="#aws-console-cloudwatch-log-groups-aws-ssm-sessions-bia-instance" aria-label="Permalink to “AWS Console &gt; CloudWatch &gt; Log groups &gt; /aws/ssm/sessions/bia-instance”">​</a></h1><h1 id="notas-importantes" tabindex="-1">Notas importantes: <a class="header-anchor" href="#notas-importantes" aria-label="Permalink to “Notas importantes:”">​</a></h1><h1 id="nenhuma-porta-ssh-22-esta-aberta" tabindex="-1">- Nenhuma porta SSH (22) está aberta <a class="header-anchor" href="#nenhuma-porta-ssh-22-esta-aberta" aria-label="Permalink to “- Nenhuma porta SSH (22) está aberta”">​</a></h1><h1 id="acesso-seguro-via-iam-permissions" tabindex="-1">- Acesso seguro via IAM permissions <a class="header-anchor" href="#acesso-seguro-via-iam-permissions" aria-label="Permalink to “- Acesso seguro via IAM permissions”">​</a></h1><h1 id="todas-as-sessoes-sao-logadas-no-cloudwatch" tabindex="-1">- Todas as sessões são logadas no CloudWatch <a class="header-anchor" href="#todas-as-sessoes-sao-logadas-no-cloudwatch" aria-label="Permalink to “- Todas as sessões são logadas no CloudWatch”">​</a></h1><h1 id="funciona-mesmo-em-subnets-privadas" tabindex="-1">- Funciona mesmo em subnets privadas <a class="header-anchor" href="#funciona-mesmo-em-subnets-privadas" aria-label="Permalink to “- Funciona mesmo em subnets privadas”">​</a></h1><h1 id="main-tf-instancia-ec2-com-acesso-apenas-via-ssm-configuracao-minima" tabindex="-1">main.tf - Instância EC2 com acesso apenas via SSM (configuração mínima) <a class="header-anchor" href="#main-tf-instancia-ec2-com-acesso-apenas-via-ssm-configuracao-minima" aria-label="Permalink to “main.tf - Instância EC2 com acesso apenas via SSM (configuração mínima)”">​</a></h1><p>terraform { required_version = &quot;&gt;= 1.5.0&quot;</p><p>required_providers { aws = { source = &quot;hashicorp/aws&quot; version = &quot;~&gt; 5.0&quot; } } }</p><p>provider &quot;aws&quot; { region = &quot;us-east-1&quot; profile = &quot;bia-tf&quot; }</p><h1 id="-5" tabindex="-1">----------------------------- <a class="header-anchor" href="#-5" aria-label="Permalink to “-----------------------------”">​</a></h1><h1 id="_1-ami-mais-recente-do-amazon-linux-2" tabindex="-1">1. AMI mais recente do Amazon Linux 2 <a class="header-anchor" href="#_1-ami-mais-recente-do-amazon-linux-2" aria-label="Permalink to “1. AMI mais recente do Amazon Linux 2”">​</a></h1><h1 id="-6" tabindex="-1">----------------------------- <a class="header-anchor" href="#-6" aria-label="Permalink to “-----------------------------”">​</a></h1><p>data &quot;aws_ami&quot; &quot;amazon_linux&quot; { most_recent = true owners = [&quot;amazon&quot;]</p><p>filter { name = &quot;name&quot; values = [&quot;amzn2-ami-hvm-*-x86_64-gp2&quot;] } }</p><h1 id="-7" tabindex="-1">----------------------------- <a class="header-anchor" href="#-7" aria-label="Permalink to “-----------------------------”">​</a></h1><h1 id="_2-iam-role-para-ssm" tabindex="-1">2. IAM Role para SSM <a class="header-anchor" href="#_2-iam-role-para-ssm" aria-label="Permalink to “2. IAM Role para SSM”">​</a></h1><h1 id="-8" tabindex="-1">----------------------------- <a class="header-anchor" href="#-8" aria-label="Permalink to “-----------------------------”">​</a></h1><p>resource &quot;aws_iam_role&quot; &quot;ec2_role&quot; { name = &quot;bia-ec2-role&quot;</p><p>assume_role_policy = jsonencode({ Version = &quot;2012-10-17&quot; Statement = [{ Effect = &quot;Allow&quot; Principal = { Service = &quot;ec2.amazonaws.com&quot; } Action = &quot;sts:AssumeRole&quot; }] }) }</p><h1 id="politica-minima-para-ssm-funcionar" tabindex="-1">Política mínima para SSM funcionar <a class="header-anchor" href="#politica-minima-para-ssm-funcionar" aria-label="Permalink to “Política mínima para SSM funcionar”">​</a></h1><p>resource &quot;aws_iam_role_policy_attachment&quot; &quot;ssm_core&quot; { role = aws_iam_role.ec2_role.name policy_arn = &quot;arn:aws:iam::aws:policy/AmazonSSMManagedInstanceCore&quot; }</p><p>resource &quot;aws_iam_instance_profile&quot; &quot;ec2_profile&quot; { name = &quot;bia-ec2-profile&quot; role = aws_iam_role.ec2_role.name }</p><h1 id="-9" tabindex="-1"># ----------------------------- <a class="header-anchor" href="#-9" aria-label="Permalink to “# -----------------------------”">​</a></h1><h1 id="_3-security-group-apenas-egress" tabindex="-1"># 3. Security Group (apenas egress) <a class="header-anchor" href="#_3-security-group-apenas-egress" aria-label="Permalink to “# 3. Security Group (apenas egress)”">​</a></h1><h1 id="-10" tabindex="-1"># ----------------------------- <a class="header-anchor" href="#-10" aria-label="Permalink to “# -----------------------------”">​</a></h1><h1 id="resource-aws-security-group-allow-outbound" tabindex="-1">resource &quot;aws_security_group&quot; &quot;allow_outbound&quot; { <a class="header-anchor" href="#resource-aws-security-group-allow-outbound" aria-label="Permalink to “resource &quot;aws_security_group&quot; &quot;allow_outbound&quot; {”">​</a></h1><h1 id="name-bia-allow-outbound" tabindex="-1">name = &quot;bia-allow-outbound&quot; <a class="header-anchor" href="#name-bia-allow-outbound" aria-label="Permalink to “name        = &quot;bia-allow-outbound&quot;”">​</a></h1><h1 id="description-allow-outbound-traffic-only" tabindex="-1">description = &quot;Allow outbound traffic only&quot; <a class="header-anchor" href="#description-allow-outbound-traffic-only" aria-label="Permalink to “description = &quot;Allow outbound traffic only&quot;”">​</a></h1><h1 id="⚠️-nenhuma-regra-ingress-acesso-apenas-via-ssm" tabindex="-1"># ⚠️ Nenhuma regra ingress - acesso apenas via SSM <a class="header-anchor" href="#⚠️-nenhuma-regra-ingress-acesso-apenas-via-ssm" aria-label="Permalink to “# ⚠️ Nenhuma regra ingress - acesso apenas via SSM”">​</a></h1><h1 id="egress" tabindex="-1">egress { <a class="header-anchor" href="#egress" aria-label="Permalink to “egress {”">​</a></h1><h1 id="from-port-0" tabindex="-1">from_port = 0 <a class="header-anchor" href="#from-port-0" aria-label="Permalink to “from_port   = 0”">​</a></h1><h1 id="to-port-0" tabindex="-1">to_port = 0 <a class="header-anchor" href="#to-port-0" aria-label="Permalink to “to_port     = 0”">​</a></h1><h1 id="protocol-1" tabindex="-1">protocol = &quot;-1&quot; <a class="header-anchor" href="#protocol-1" aria-label="Permalink to “protocol    = &quot;-1&quot;”">​</a></h1><h1 id="cidr-blocks-0-0-0-0-0" tabindex="-1">cidr_blocks = [&quot;0.0.0.0/0&quot;] <a class="header-anchor" href="#cidr-blocks-0-0-0-0-0" aria-label="Permalink to “cidr_blocks = [&quot;0.0.0.0/0&quot;]”">​</a></h1><h1 id="-11" tabindex="-1">} <a class="header-anchor" href="#-11" aria-label="Permalink to “}”">​</a></h1><h1 id="-12" tabindex="-1">} <a class="header-anchor" href="#-12" aria-label="Permalink to “}”">​</a></h1><h1 id="-13" tabindex="-1">----------------------------- <a class="header-anchor" href="#-13" aria-label="Permalink to “-----------------------------”">​</a></h1><h1 id="_3-security-group-porta-3001-ssm" tabindex="-1">3. Security Group (Porta 3001 + SSM) <a class="header-anchor" href="#_3-security-group-porta-3001-ssm" aria-label="Permalink to “3. Security Group (Porta 3001 + SSM)”">​</a></h1><h1 id="-14" tabindex="-1">----------------------------- <a class="header-anchor" href="#-14" aria-label="Permalink to “-----------------------------”">​</a></h1><p>resource &quot;aws_security_group&quot; &quot;bia_app_sg&quot; { name = &quot;bia-app-security-group&quot; description = &quot;Allow port 3001 for app and SSM access&quot;</p><h1 id="regra-para-sua-aplicacao-porta-3001" tabindex="-1">Regra para sua aplicação (porta 3001) <a class="header-anchor" href="#regra-para-sua-aplicacao-porta-3001" aria-label="Permalink to “Regra para sua aplicação (porta 3001)”">​</a></h1><p>ingress { description = &quot;Allow HTTP on port 3001&quot; from_port = 3001 to_port = 3001 protocol = &quot;tcp&quot; cidr_blocks = [&quot;0.0.0.0/0&quot;] }</p><h1 id="permite-todo-trafego-de-saida" tabindex="-1">Permite todo tráfego de saída <a class="header-anchor" href="#permite-todo-trafego-de-saida" aria-label="Permalink to “Permite todo tráfego de saída”">​</a></h1><p>egress { from_port = 0 to_port = 0 protocol = &quot;-1&quot; cidr_blocks = [&quot;0.0.0.0/0&quot;] }</p><p>tags = { Name = &quot;bia-app-sg&quot; } }</p><h1 id="-15" tabindex="-1">----------------------------- <a class="header-anchor" href="#-15" aria-label="Permalink to “-----------------------------”">​</a></h1><h1 id="_4-ec2-instance" tabindex="-1">4. EC2 Instance <a class="header-anchor" href="#_4-ec2-instance" aria-label="Permalink to “4. EC2 Instance”">​</a></h1><h1 id="-16" tabindex="-1">----------------------------- <a class="header-anchor" href="#-16" aria-label="Permalink to “-----------------------------”">​</a></h1><p>resource &quot;aws_instance&quot; &quot;bia_dev&quot; { ami = data.aws_ami.amazon_linux.id instance_type = &quot;t3.micro&quot;</p><h1 id="associa-o-profile-iam-com-permissoes-ssm" tabindex="-1">Associa o profile IAM com permissões SSM <a class="header-anchor" href="#associa-o-profile-iam-com-permissoes-ssm" aria-label="Permalink to “Associa o profile IAM com permissões SSM”">​</a></h1><p>iam_instance_profile = aws_iam_instance_profile.ec2_profile.name</p><h1 id="security-group-que-permite-apenas-saida" tabindex="-1">Security Group que permite apenas saída <a class="header-anchor" href="#security-group-que-permite-apenas-saida" aria-label="Permalink to “Security Group que permite apenas saída”">​</a></h1><p>vpc_security_group_ids = [aws_security_group.bia_app_sg.id]</p><h1 id="user-data-a-partir-de-arquivo-externo" tabindex="-1">User data a partir de arquivo externo <a class="header-anchor" href="#user-data-a-partir-de-arquivo-externo" aria-label="Permalink to “User data a partir de arquivo externo”">​</a></h1><p>user_data = file(&quot;userdata.sh&quot;)</p><p>tags = { Name = &quot;bia-ssm-instance&quot; } }</p><h1 id="-17" tabindex="-1">----------------------------- <a class="header-anchor" href="#-17" aria-label="Permalink to “-----------------------------”">​</a></h1><h1 id="_5-output-essencial" tabindex="-1">5. Output essencial <a class="header-anchor" href="#_5-output-essencial" aria-label="Permalink to “5. Output essencial”">​</a></h1><h1 id="-18" tabindex="-1">----------------------------- <a class="header-anchor" href="#-18" aria-label="Permalink to “-----------------------------”">​</a></h1><p>output &quot;instance_id&quot; { value = aws_instance.bia_dev.id }</p><p>output &quot;connect_command&quot; { value = &quot;aws ssm start-session --target ${aws_instance.bia_dev.id}&quot; }</p>',67)])])}const f=s(n,[["render",c]]);export{b as __pageData,f as default};
